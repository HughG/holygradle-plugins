<!DOCTYPE html>
<html>
    <head>
        <title>Artifactory Repository Tree</title>

        <link rel="stylesheet" href="joint.min.css" />

        <style>
#paper {
   width: 1250px;
   height: 1250px;
}
        </style>

        <script src="joint.min.js" type="text/javascript"></script>
        <script src="joint.layout.DirectedGraph.min.js" type="text/javascript"></script>
    </head>

    <body>
        <div id="paper"></div>

        <script type="text/javascript">
var graph = new joint.dia.Graph;

var paper = new joint.dia.Paper({
    el: $('#paper'),
    width: 1230,
    height: 1230,
    gridSize: 1,
    model: graph
});

// Required to ensure full borders & drop-shadows are visible
V(paper.viewport).translate(20, 20);


function makeRepo (remote, label) {
    return new joint.shapes.basic.Rect({
        id: label,
        size: {
            width: 165,
            height: 20
        },
        attrs: {
            text: {
                text: label,
                'font-size': 13,
                'font-family': 'Arial, Myriad, Helvetica, clean, sans-serif',
                y: 12
            },
            rect: {
                width: 165,
                height: 20,
                stroke: '#000000',
                'stroke-width': remote? 0: 1,
                fill: '#B2DB71'
            }
        }
    });
}

function makeRefLink (remote, repoLabel, refLabel) {
    return new joint.dia.Link({
        source: { id: repoLabel },
        target: { id: refLabel },
        attrs: {
            '.connection': {
                stroke: '#5D5C5D',
                'stroke-width': remote? 1: 2,
                'stroke-dasharray': '1,1'
            },
            '.marker-target': {
                d: 'M 10 0 L 0 5 L 10 10 z',
                'stroke-width': 0,
                fill: '#5D5C5D'
            }
        },
        smooth: true
    });
}

function buildGraphFromAdjacencyList (adjacencyList) {
    var repos = [];
    var links = [];

    // Create a text box for each repo
    _.each(adjacencyList, function(edges, repoLabel) {
        var remote = (repoLabel.substr(0, 7) == "REMOTE:");

        if (remote) {
            repoLabel = repoLabel.substr(7);
        }

        repos.push(makeRepo(remote, repoLabel));

        // Create a link arrow for each referenced repo
        _.each(edges, function(refLabel) {
            var remoteRef = (("REMOTE:" + refLabel) in adjacencyList);
            links.push(makeRefLink(remoteRef, repoLabel, refLabel));
        });
    });

    // Links must be added after the repos to which they refer.
    return repos.concat(links);
}

$.ajax(
    "http://localhost:8081/artifactory/api/plugins/execute/getRepositoryTree"
).done(function(response) {
    // Turn the response into JSON
    try {
        var adjacencyList = eval('adjacencyList = ' + response);
    } catch (e) {
        alert(e);
    }

    // Build the graph based on the JSON
    var cells = buildGraphFromAdjacencyList(adjacencyList);

    // Lay out the new graph
    graph.resetCells(cells);
    joint.layout.DirectedGraph.layout(
        graph,
        {
            setLinkVertices: false,
            rankDir: "RL",
            nodeSep: 20,
            rankSep: 60
        }
    );
}).fail(function(jqXHR, status) {
    // Display the error in place of the graph
    var cells = [];
    cells.push(makeRepo(false, "Fail: " + status));
    graph.resetCells(cells);
});
        </script>
    </body>
</html>